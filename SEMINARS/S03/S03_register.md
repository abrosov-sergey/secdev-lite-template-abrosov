# S03 - Реестр NFR для сервиса вызова такси

| ID      | User Story / Feature                  | Category                  | Requirement (NFR)                                                                 | Rationale / Risk                        | Acceptance (G-W-T)                                                                                                         | Evidence (test/log/scan/policy)         | Trace (issue/link) | Owner   | Status   | Priority    | Severity   | Tags                  |
| ------- | ------------------------------------- | ------------------------- | ------------------------------------------------------------------------------- | --------------------------------------- | -------------------------------------------------------------------------------------------------------------------------- | --------------------------------------- | ------------------ | ------- | -------- | ----------- | ---------- | --------------------- |
| NFR-101 | Уведомление о приезде такси           | RateLimiting              | Не более 3 уведомлений на пользователя в течение 10 минут                        | Защита от спама и DoS                   | **Given** пользователь получает уведомления<br>**When** отправляется 4-е уведомление за 10 минут<br>**Then** ответ 429     | test: e2e-rate-limit                    | #taxi-notify      | team-taxi | Draft    | P1 - High   | S2 - Major | rate,notify           |
| NFR-102 | Уведомление о приезде такси           | Timeouts/Retry            | Внешние вызовы на SMS/email/push: timeout ≤ 2s, retry ≤ 2                        | Устойчивость к зависимостям             | **Given** недоступность внешнего сервиса<br>**When** отправляется уведомление<br>**Then** не более 2 попыток, ожидание ≤2s | test: integration-fail                  | #taxi-notify      | team-taxi | Draft    | P2 - Medium | S2 - Major | timeout,retry         |
| NFR-103 | Уведомление о приезде такси           | Privacy/PII               | PII не попадает в логи, хранится ≤ 7 дней                                        | Соответствие privacy и комплаенсу       | **Given** логирование события<br>**When** в логе есть персональные данные<br>**Then** они маскированы или удалены          | log: masked-example                     | #taxi-notify      | team-taxi | Draft    | P1 - High   | S1 - Critical | privacy,pii         |
| NFR-104 | Уведомление о приезде такси           | Performance               | P95 задержки отправки уведомления ≤ 500 мс при 30 RPS в течение 5 минут          | UX/SLO, своевременность оповещения      | **Given** сервис здоров<br>**When** 30 RPS на /api/notifications/ride-arrival 5 минут<br>**Then** P95 ≤ 500 мс, error ≤ 1% | test: load-30rps                        | #taxi-notify      | team-taxi | Draft    | P2 - Medium | S2 - Major | perf,slo              |
| NFR-105 | Уведомление о приезде такси           | API-Contract/Errors       | Ошибки возвращаются в формате RFC 7807 без стэктрейсов                           | Предсказуемость и безопасность          | **Given** ошибка при POST /api/notifications/ride-arrival<br>**When** клиент получает ответ<br>**Then** RFC7807, нет stack | test: contract-error                    | #taxi-notify      | team-taxi | Draft    | P2 - Medium | S2 - Major | api,error             |
| NFR-106 | Уведомление о приезде такси           | Security-InputValidation  | Размер тела запроса ≤ 0.5 MiB, MIME только из allowlist, лишние поля запрещены   | Защита от DoS и грязных данных          | **Given** тело 1 MiB или неизвестные поля<br>**When** POST /api/notifications/ride-arrival<br>**Then** 413 или 400        | test: input-validation                  | #taxi-notify      | team-taxi | Draft    | P2 - Medium | S2 - Major | validation,security   |
| NFR-201 | Заказ такси                           | RateLimiting              | Не более 5 заказов на пользователя в течение 30 минут                            | Защита от спама и злоупотреблений       | **Given** пользователь оформляет заказы<br>**When** отправляется 6-й заказ за 30 минут<br>**Then** ответ 429              | test: e2e-rate-limit                    | #taxi-order       | team-taxi | Draft    | P1 - High   | S2 - Major | rate,order            |
| NFR-202 | Заказ такси                           | Security-AuthN            | Только аутентифицированные пользователи могут создавать заказы                    | Защита от несанкционированных действий  | **Given** неаутентифицированный пользователь<br>**When** POST /api/orders<br>**Then** ответ 401                           | test: auth-required                     | #taxi-order       | team-taxi | Draft    | P1 - High   | S2 - Major | auth,security         |
| NFR-203 | Заказ такси                           | Performance               | P95 задержки создания заказа ≤ 700 мс при 20 RPS в течение 5 минут               | UX/SLO, скорость оформления заказа      | **Given** сервис здоров<br>**When** 20 RPS на /api/orders 5 минут<br>**Then** P95 ≤ 700 мс, error ≤ 1%                    | test: load-20rps                        | #taxi-order       | team-taxi | Draft    | P2 - Medium | S2 - Major | perf,slo              |
| NFR-204 | Заказ такси                           | API-Contract/Errors       | Ошибки возвращаются в формате RFC 7807 без стэктрейсов                           | Предсказуемость и безопасность          | **Given** ошибка при POST /api/orders<br>**When** клиент получает ответ<br>**Then** RFC7807, нет stack                     | test: contract-error                    | #taxi-order       | team-taxi | Draft    | P2 - Medium | S2 - Major | api,error             |
| NFR-205 | Заказ такси                           | Data-Integrity            | Все параметры заказа валидируются и нормализуются перед записью                   | Целостность и корректность данных       | **Given** невалидные или неканоничные данные<br>**When** POST /api/orders<br>**Then** 400 или нормализация                 | test: data-integrity                    | #taxi-order       | team-taxi | Draft    | P2 - Medium | S2 - Major | integrity,validation  |
| NFR-206 | Заказ такси                           | Security-InputValidation  | Размер тела запроса ≤ 1 MiB, MIME только из allowlist, лишние поля запрещены     | Защита от DoS и грязных данных          | **Given** тело 2 MiB или неизвестные поля<br>**When** POST /api/orders<br>**Then** 413 или 400                             | test: input-validation                  | #taxi-order       | team-taxi | Draft    | P2 - Medium | S2 - Major | validation,security   |
| NFR-301 | Регистрация пользователя              | RateLimiting              | Не более 5 регистраций с одного IP за 10 минут                                   | Защита от спама и автоматических атак   | **Given** 5 регистраций с одного IP<br>**When** отправляется 6-я регистрация за 10 минут<br>**Then** ответ 429             | test: e2e-rate-limit                    | #taxi-register     | team-taxi | Draft    | P1 - High   | S2 - Major | rate,register         |
| NFR-302 | Регистрация пользователя              | Security-InputValidation  | Email/телефон валидируются, пароль ≥ 8 символов, запрещены лишние поля           | Защита от некорректных и вредоносных данных | **Given** невалидный email или короткий пароль<br>**When** POST /api/auth/register<br>**Then** 400                        | test: input-validation                  | #taxi-register     | team-taxi | Draft    | P1 - High   | S2 - Major | validation,security   |
| NFR-303 | Регистрация пользователя              | Privacy/PII               | PII не попадает в логи, хранится ≤ 7 дней                                        | Соответствие privacy и комплаенсу       | **Given** логирование события<br>**When** в логе есть персональные данные<br>**Then** они маскированы или удалены          | log: masked-example                     | #taxi-register     | team-taxi | Draft    | P1 - High   | S1 - Critical | privacy,pii         |
| NFR-304 | Регистрация пользователя              | API-Contract/Errors       | Ошибки возвращаются в формате RFC 7807 без стэктрейсов                           | Предсказуемость и безопасность          | **Given** ошибка при POST /api/auth/register<br>**When** клиент получает ответ<br>**Then** RFC7807, нет stack              | test: contract-error                    | #taxi-register     | team-taxi | Draft    | P2 - Medium | S2 - Major | api,error             |
| NFR-305 | Регистрация пользователя              | Security-AuthN            | После регистрации пользователь получает валидный токен, невалидный → 401         | Безопасность доступа к сервису          | **Given** невалидные данные<br>**When** POST /api/auth/register<br>**Then** 401                                            | test: auth-required                     | #taxi-register     | team-taxi | Draft    | P2 - Medium | S2 - Major | auth,security         |
| NFR-306 | Регистрация пользователя              | Data-Integrity            | Все данные профиля валидируются и нормализуются перед записью                     | Целостность и корректность данных       | **Given** невалидные или неканоничные данные<br>**When** POST /api/auth/register<br>**Then** 400 или нормализация          | test: data-integrity                    | #taxi-register     | team-taxi | Draft    | P2 - Medium | S2 - Major | integrity,validation  |
| NFR-401 | Просмотр истории поездок             | Security-AuthZ/RBAC       | Пользователь видит только свои поездки, изоляция по tenant/user_id               | Защита приватности данных               | **Given** пользователь A запрашивает историю<br>**When** в ответе есть поездки пользователя B<br>**Then** ответ пустой или 403 | test: authz-isolation                   | #taxi-history     | team-taxi | Draft    | P1 - High   | S1 - Critical | security,authz       |
| NFR-402 | Просмотр истории поездок             | Privacy/PII               | PII водителя маскируется в ответах (только имя и рейтинг)                        | Соответствие GDPR и privacy policies    | **Given** запрос истории поездок<br>**When** в ответе есть телефон/email водителя<br>**Then** они удалены или маскированы | test: pii-masking                       | #taxi-history     | team-taxi | Draft    | P1 - High   | S2 - Major | privacy,pii          |
| NFR-403 | Просмотр истории поездок             | Performance               | P95 времени ответа ≤ 300 мс при 50 RPS в течение 5 минут                         | UX/SLO, быстрый доступ к истории        | **Given** сервис здоров<br>**When** 50 RPS на /api/rides/history 5 минут<br>**Then** P95 ≤ 300 мс, error ≤ 1%              | test: load-50rps                        | #taxi-history     | team-taxi | Draft    | P2 - Medium | S2 - Major | perf,slo              |
| NFR-404 | Просмотр истории поездок             | API-Contract/Errors       | Пагинация: limit ≤ 100, offset ≥ 0, сортировка по дате создания                   | Защита от перегрузки и предсказуемость  | **Given** запрос с limit=200<br>**When** GET /api/rides/history<br>**Then** 400 или обрезание до 100                      | test: pagination-validation             | #taxi-history     | team-taxi | Draft    | P2 - Medium | S3 - Minor | api,pagination        |
| NFR-405 | Просмотр истории поездок             | Data-Integrity            | Сумма стоимости поездки соответствует тарифу и дистанции                         | Финансовая корректность и аудит         | **Given** завершённая поездка<br>**When** проверяется сумма в истории<br>**Then** она равна расчётной по тарифу            | test: fare-calculation                  | #taxi-history     | team-taxi | Draft    | P2 - Medium | S2 - Major | integrity,finance     |
| NFR-501 | Оценка поездки и водителя            | Data-Integrity            | Один отзыв на поездку, повторная оценка перезаписывает предыдущую                | Целостность рейтинговой системы         | **Given** существующий отзыв от пользователя<br>**When** отправляется новый отзыв<br>**Then** старый заменяется, новый сохранён | test: rating-uniqueness                 | #taxi-feedback    | team-taxi | Draft    | P2 - Medium | S2 - Major | integrity,rating      |
| NFR-502 | Оценка поездки и водителя            | Security-AuthZ/RBAC       | Только пассажир поездки может оставить отзыв                                     | Защита от накрутки рейтинга             | **Given** пользователь не участвовал в поездке<br>**When** POST /api/rides/{id}/rating<br>**Then** ответ 403               | test: authz-ride-participant            | #taxi-feedback    | team-taxi | Draft    | P1 - High   | S2 - Major | security,authz       |
| NFR-503 | Оценка поездки и водителя            | RateLimiting              | Не более 10 оценок в час с одного аккаунта                                       | Защита от спама и злоупотреблений       | **Given** 10 оценок за час<br>**When** отправляется 11-я оценка<br>**Then** ответ 429                                     | test: e2e-rate-limit                    | #taxi-feedback    | team-taxi | Draft    | P2 - Medium | S2 - Major | rate,feedback         |
| NFR-504 | Оценка поездки и водителя            | API-Contract/Errors       | Рейтинг только 1-5 звёзд, текст отзыва ≤ 1000 символов                           | Валидация бизнес-логики                 | **Given** рейтинг 6 или текст 2000 символов<br>**When** POST /api/rides/{id}/rating<br>**Then** 400                        | test: input-validation                  | #taxi-feedback    | team-taxi | Draft    | P2 - Medium | S2 - Major | api,validation        |
| NFR-505 | Оценка поездки и водителя            | Auditability              | Все изменения рейтингов логируются с user_id и timestamp                         | Аудит и расследование инцидентов        | **Given** отправлен отзыв<br>**When** проверяется лог<br>**Then** есть запись с user_id, ride_id, rating, timestamp        | log: audit-example                      | #taxi-feedback    | team-taxi | Draft    | P2 - Medium | S2 - Major | audit,logging         |
| NFR-601 | Управление способами оплаты          | Security-Secrets          | Токены карт хранятся только у PCI DSS провайдера, не в нашей БД                  | Соответствие PCI DSS стандартам         | Given добавление карты<br>**When** проверяется хранение<br>**Then** в БД только reference token, не данные карты       | scan: pci-compliance                    | #taxi-payment     | team-taxi | Draft    | P1 - High   | S1 - Critical | security,pci         |
| NFR-602 | Управление способами оплаты          | Privacy/PII               | Маскирование номеров карт в логах (только последние 4 цифры)                     | Защита платёжных данных                 | Given логирование операций с картами<br>**When** в логе есть номер карты<br>**Then** он маскирован как ****1234        | log: masked-card-example                | #taxi-payment     | team-taxi | Draft    | P1 - High   | S1 - Critical | privacy,pci          |
| NFR-603 | Управление способами оплаты          | Security-AuthZ/RBAC       | Только владелец аккаунта может управлять своими платёжными методами              | Защита от несанкционированного доступа  | Given пользователь A<br>**When** DELETE /api/payment-methods/{id} пользователя B<br>**Then** ответ 403                 | test: authz-payment-methods             | #taxi-payment     | team-taxi | Draft    | P1 - High   | S2 - Major | security,authz       |
| NFR-604 | Управление способами оплаты          | API-Contract/Errors       | Валидация данных карты: номер, срок действия, CVC                                | Предотвращение ошибок и мошенничества   | Given невалидный номер карты<br>**When** POST /api/payment-methods<br>**Then** 400 с деталями ошибки                  | test: card-validation                   | #taxi-payment     | team-taxi | Draft    | P2 - Medium | S2 - Major | api,validation        |
| NFR-605 | Управление способами оплаты          | Auditability              | Все операции с платёжными методами логируются (добавление/удаление)              | Трассируемость финансовых операций      | Given изменение платёжных методов<br>**When** проверяется лог<br>**Then** есть запись с action, user_id, timestamp     | log: payment-audit-example              | #taxi-payment     | team-taxi | Draft    | P2 - Medium | S2 - Major | audit,finance         |
<!-- ...existing code... -->
