# Матрицы вариантов

## R-01 — Компрометация токена / захват аккаунта (Edge: Internet → API (JWT))
NFR links: NFR-202, NFR-305, NFR-101

| Alternative | Summary | Security impact (↑1-5) | Blast radius reduction (↑1-5) | Complexity (↓1-5) | Time-to-mitigate (↓1-5) | Dependencies (↓1-5) | Benefit | Cost | Net | Notes |
| ------------ | ---------------- | ---------------------: | ---------------------------: | ----------------: | ----------------------: | ------------------: | ------: | ----: | ---: | ----- |
| O1 (выбрано) | JWT TTL 15m + Refresh 7d + отзыв | 4 | 3 | 2 | 2 | 2 | 7 | 6 | +1 | Быстрый запуск, паттерн 1 |
| O2 | Обязательное MFA / step-up для критичных действий | 5 | 4 | 3 | 3 | 2 | 9 | 8 | +1 | Высокая безопасность, ухудшение UX |
| O3 | Жёсткие лимиты auth + привязка устройства | 3 | 2 | 2 | 1 | 2 | 5 | 5 | 0 | Снижает brute-force, операционная нагрузка |

Recommendation: внедрить O1 в первую очередь, затем O3; O2 — для админов / VIP.

---

## R-02 — Утечка PII в логах/БД (Node: Service/DB/Logs)
NFR links: NFR-103, NFR-303, NFR-106

| Alternative | Summary | Security impact (↑1-5) | Blast radius reduction (↑1-5) | Complexity (↓1-5) | Time-to-mitigate (↓1-5) | Dependencies (↓1-5) | Benefit | Cost | Net | Notes |
| ------------ | ---------------- | ---------------------: | ---------------------------: | ----------------: | ----------------------: | ------------------: | ------: | ----: | ---: | ----- |
| O1 (выбрано) | Маскирование PII в логах и редактирование полей на уровне логгера | 4 | 4 | 2 | 1 | 1 | 8 | 4 | +4 | Быстро и мало зависимостей |
| O2 | Политика хранения: raw PII ≤7 дней + фоновые purge-job'ы | 3 | 3 | 2 | 2 | 2 | 6 | 6 | 0 | Требуется аккуратная реализация очистки |
| O3 | Шифрование полей PII в БД и управление ключами | 5 | 5 | 4 | 4 | 3 | 10 | 11 | -1 | Сильно снижает риск, но дорого/сложно |

Recommendation: O1 + O2; O3 — для особо чувствительных полей.

---

## R-03 — Зависание внешнего провайдера (Edge: Service → External API)
NFR links: NFR-102, NFR-104

| Alternative | Summary | Security impact (↑1-5) | Blast radius reduction (↑1-5) | Complexity (↓1-5) | Time-to-mitigate (↓1-5) | Dependencies (↓1-5) | Benefit | Cost | Net | Notes |
| ------------ | ---------------- | ---------------------: | ---------------------------: | ----------------: | ----------------------: | ------------------: | ------: | ----: | ---: | ----- |
| O1 (выбрано) | Таймаут ≤2s + retry≤3 (jitter) + circuit-breaker | 3 | 3 | 2 | 1 | 1 | 6 | 4 | +2 | Паттерн 6, базовая защита |
| O2 | Асинхронный fallback: очередь, 202 + background job | 4 | 4 | 4 | 3 | 3 | 8 | 10 | -2 | Для non-blocking сценариев; сложнее UX |
| O3 | Кэш с коротким TTL ответов провайдера (5–30s) | 2 | 2 | 2 | 1 | 1 | 4 | 4 | 0 | Уменьшает вызовы, риск устаревших данных |

Recommendation: O1 как базовая защита; O2 — для операций, терпимых к eventual consistency.

---

## R-04 — Манипуляция полей заказа (Edge: Internet → API order input)
NFR links: NFR-206, NFR-302, NFR-205

| Alternative | Summary | Security impact (↑1-5) | Blast radius reduction (↑1-5) | Complexity (↓1-5) | Time-to-mitigate (↓1-5) | Dependencies (↓1-5) | Benefit | Cost | Net | Notes |
| ------------ | ---------------- | ---------------------: | ---------------------------: | ----------------: | ----------------------: | ------------------: | ------: | ----: | ---: | ----- |
| O1 (выбрано) | Серверная валидация схемы + reject extra fields | 4 | 3 | 2 | 1 | 1 | 7 | 4 | +3 | Паттерн 3, быстрая защита |
| O2 | Канонизация + integrity checks (нормализация, подпись полей) | 3 | 3 | 3 | 2 | 2 | 6 | 7 | -1 | Снижает логические ошибки |
| O3 | Idempotency keys + хеширование полезной нагрузки для записей | 2 | 2 | 2 | 2 | 1 | 4 | 5 | -1 | Защита от повторов/дубликатов |

Recommendation: O1 первично; O2 — при сложной нормализации.

---

## R-05 — Массовые запросы / спам заказов (Edge: Internet → API)
NFR links: NFR-201, NFR-101, NFR-301

| Alternative | Summary | Security impact (↑1-5) | Blast radius reduction (↑1-5) | Complexity (↓1-5) | Time-to-mitigate (↓1-5) | Dependencies (↓1-5) | Benefit | Cost | Net | Notes |
| ------------ | ---------------- | ---------------------: | ---------------------------: | ----------------: | ----------------------: | ------------------: | ------: | ----: | ---: | ----- |
| O1 (выбрано) | Глобальные и per-user rate limits (напр., 60 req/min) + 429 | 4 | 3 | 2 | 1 | 1 | 7 | 4 | +3 | Быстро через gateway |
| O2 | Квоты по планам + прогрессивное throttling + captcha | 4 | 4 | 3 | 3 | 2 | 8 | 8 | 0 | Долгосрочная продуктовая политика |
| O3 | Idempotency / верификация для массовых операций | 3 | 3 | 3 | 2 | 2 | 6 | 7 | -1 | Для batch endpoint'ов |

Recommendation: внедрить O1 на gateway немедленно; планировать O2 как политику продукта.

## R-06 — Утечка платежных данных (Edge: Client → Payment Service)
NFR links: NFR-601, NFR-602

| Alternative | Summary | Security impact (↑1-5) | Blast radius reduction (↑1-5) | Complexity (↓1-5) | Time-to-mitigate (↓1-5) | Dependencies (↓1-5) | Benefit | Cost | Net | Notes |
| ------------ | ---------------- | ---------------------: | ---------------------------: | ----------------: | ----------------------: | ------------------: | ------: | ----: | ---: | ----- |
| O1 (выбрано) | Токенизация через PCI DSS провайдер + маскирование в логах | 5 | 5 | 2 | 2 | 3 | 10 | 7 | +3 | Соответствие стандартам, провайдер берёт риски |
| O2 | Локальное шифрование с HSM + строгий контроль доступа | 4 | 4 | 5 | 4 | 4 | 8 | 13 | -5 | Требует PCI DSS сертификации инфраструктуры |
| O3 | Маскирование на уровне приложения + ограниченное хранение | 3 | 3 | 3 | 1 | 1 | 6 | 5 | +1 | Быстро, но недостаточно для compliance |

Recommendation: внедрить O1 как основное решение; O3 — для временной защиты во время миграции.

---

## R-07 — Неавторизованный доступ к платежным методам (Node: Payment Service)
NFR links: NFR-603

| Alternative | Summary | Security impact (↑1-5) | Blast radius reduction (↑1-5) | Complexity (↓1-5) | Time-to-mitigate (↓1-5) | Dependencies (↓1-5) | Benefit | Cost | Net | Notes |
| ------------ | ---------------- | ---------------------: | ---------------------------: | ----------------: | ----------------------: | ------------------: | ------: | ----: | ---: | ----- |
| O1 (выбрано) | RBAC с проверкой владения + resource-based policies | 4 | 4 | 2 | 2 | 2 | 8 | 6 | +2 | Чёткие правила доступа на уровне ресурсов |
| O2 | MFA для операций с платежными методами | 5 | 5 | 3 | 3 | 3 | 10 | 9 | +1 | Максимальная безопасность, сложнее UX |
| O3 | Детальное аудит-логирование всех операций | 3 | 2 | 2 | 1 | 1 | 5 | 4 | +1 | Обнаружение, но не предотвращение |

Recommendation: внедрить O1 как основу; дополнить O3 для аудита; O2 — для премиум-пользователей.

---

## R-08 — Накрутка рейтингов (Node: Rating Service)
NFR links: NFR-503, NFR-502

| Alternative | Summary | Security impact (↑1-5) | Blast radius reduction (↑1-5) | Complexity (↓1-5) | Time-to-mitigate (↓1-5) | Dependencies (↓1-5) | Benefit | Cost | Net | Notes |
| ------------ | ---------------- | ---------------------: | ---------------------------: | ----------------: | ----------------------: | ------------------: | ------: | ----: | ---: | ----- |
| O1 (выбрано) | Rate limiting (10/час) + проверка участника поездки | 4 | 4 | 2 | 1 | 1 | 8 | 4 | +4 | Быстро и эффективно против базовых атак |
| O2 | Верификация телефона для оставления отзывов | 5 | 5 | 3 | 3 | 3 | 10 | 9 | +1 | Сильная защита, барьер для пользователей |
| O3 | Анализ паттернов поведения + машинное обучение | 4 | 4 | 5 | 5 | 4 | 8 | 14 | -6 | Перспективно, но сложно и долго |

Recommendation: внедрить O1 немедленно; O2 — при росте атак; O3 — долгосрочная roadmap.

---

## R-09 — Утечка истории поездок (Node: Ride History Service)
NFR links: NFR-401, NFR-402

| Alternative | Summary | Security impact (↑1-5) | Blast radius reduction (↑1-5) | Complexity (↓1-5) | Time-to-mitigate (↓1-5) | Dependencies (↓1-5) | Benefit | Cost | Net | Notes |
| ------------ | ---------------- | ---------------------: | ---------------------------: | ----------------: | ----------------------: | ------------------: | ------: | ----: | ---: | ----- |
| O1 (выбрано) | RBAC изоляция + маскирование PII водителя | 4 | 4 | 2 | 2 | 2 | 8 | 6 | +2 | Баланс безопасности и практичности |
| O2 | Полное шифрование истории поездок | 5 | 5 | 4 | 4 | 3 | 10 | 11 | -1 | Максимальная защита, сложность доступа |
| O3 | Временное хранение + автоматическое удаление | 3 | 3 | 3 | 3 | 2 | 6 | 8 | -2 | Соответствует GDPR, ограничивает функциональность |

Recommendation: внедрить O1 как основное решение; O3 — рассмотреть для GDPR compliance roadmap.
